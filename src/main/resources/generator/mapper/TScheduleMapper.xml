<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.himwei.testtemplatebackend.mapper.TScheduleMapper">

    <resultMap id="BaseResultMap" type="com.himwei.testtemplatebackend.model.entity.TSchedule">
            <id property="id" column="id" />
            <result property="doctorId" column="doctor_id" />
            <result property="workDate" column="work_date" />
            <result property="shiftType" column="shift_type" />
            <result property="quota" column="quota" />
            <result property="bookedNum" column="booked_num" />
            <result property="status" column="status" />
            <result property="createTime" column="create_time" />
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <sql id="Base_Column_List">
        id,doctor_id,work_date,shift_type,quota,booked_num,update_time,
        status,create_time
    </sql>
    <select id="selectScheduleVOPage" resultType="com.himwei.testtemplatebackend.model.vo.ScheduleVO">
        SELECT
        s.id, s.work_date, s.shift_type, s.quota, s.booked_num, s.status, s.doctor_id,
        u.nickname AS doctorName,
        d.title,
        d.price,
        dep.dept_name AS deptName
        FROM t_schedule s
        LEFT JOIN t_doctor d ON s.doctor_id = d.id
        LEFT JOIN sys_user u ON d.user_id = u.id
        LEFT JOIN t_department dep ON d.dept_id = dep.id
        <where>
            <if test="query.doctorId != null">
                AND s.doctor_id = #{query.doctorId}
            </if>
            <if test="query.status != null">
                AND s.status = #{query.status}
            </if>
            <!-- 这里的 deptId 是前端传参，要通过 doctor 表来筛选 -->
            <if test="query.deptId != null">
                AND d.dept_id = #{query.deptId}
            </if>
            <!-- 只查今天及以后的排班 -->
            AND s.work_date >= CURDATE()
        </where>
        ORDER BY s.work_date ASC, s.shift_type ASC
    </select>
</mapper>
